<!-- CHATBOT - WIDGET (VERSIÃ“N BURBUJA) -->

<!-- Burbuja flotante -->
<div id="chat-bubble">ðŸ’¬</div>

<!-- Ventana del chat -->
<div id="chat-window" aria-live="polite" aria-label="Asistente Instalaciones Universales">
  <div id="chat-header">
    <button id="chat-control-btn" title="Cerrar chat">âœ–</button>
    <span>sistente Instalaciones Universales</span>
    <span style="width: 30px;"></span>
  </div>

  <div id="chat-messages" role="log">
    <p class="bot-message">
      Hola, soy tu asistente de Instalaciones Universales. <br><br>
      Â¿En quÃ© puedo ayudarte hoy?
    </p>
  </div>

  <form id="chat-form" autocomplete="off" role="search">
    <input type="text" id="chat-input" placeholder="EscrÃ­beme algo aquÃ­..." autocomplete="off" />
    <button type="submit" id="chat-send-btn">Enviar</button>
  </form>
</div>

<style>
/* ===== BURBUJA ===== */
#chat-bubble {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 65px;
  height: 65px;
  background: #39ff14;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  cursor: pointer;
  box-shadow: 0 6px 15px rgba(0,0,0,0.3);
  z-index: 10000;
}

/* ===== VENTANA DEL CHAT ===== */
#chat-window {
  display: none;
  position: fixed;
  bottom: 100px;
  right: 20px;
  width: 330px;
  height: 430px;
  background: white;
  border-radius: 25px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.4);
  flex-direction: column;
  overflow: hidden;
  z-index: 9999;
  font-family: Arial, sans-serif;
}

/* Flechita de burbuja */
#chat-window::after {
  content: "";
  position: absolute;
  bottom: -15px;
  right: 35px;
  width: 0;
  height: 0;
  border-left: 15px solid transparent;
  border-right: 15px solid transparent;
  border-top: 15px solid white;
}

/* Header */
#chat-header {
  background: #0a2a43;
  color: white;
  padding: 10px 12px;
  font-size: 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* BotÃ³n cerrar */
#chat-control-btn {
  background: transparent;
  border: none;
  color: white;
  font-size: 18px;
  cursor: pointer;
}

/* Mensajes */
#chat-messages {
  flex: 1;
  padding: 14px;
  overflow-y: auto;
  background: #f7f9fb;
}

.bot-message {
  background: #dbeaff;
  padding: 10px;
  border-radius: 12px;
  margin-bottom: 10px;
  max-width: 85%;
}

.user-message {
  background: #d1ffd0;
  padding: 10px;
  border-radius: 12px;
  margin-bottom: 10px;
  max-width: 85%;
  margin-left: auto;
}

/* Formulario */
#chat-form {
  display: flex;
  padding: 10px;
  background: #ffffff;
  gap: 8px;
  align-items: center;
  border-top: 1px solid #eee;
}

#chat-input {
  flex: 1;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 12px;
  outline: none;
}

#chat-send-btn {
  background: #0a2a43;
  color: white;
  border: none;
  padding: 9px 12px;
  border-radius: 12px;
  cursor: pointer;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const chatWindow = document.getElementById("chat-window");
  const chatBubble = document.getElementById("chat-bubble");
  const controlBtn = document.getElementById("chat-control-btn");
  const form = document.getElementById("chat-form");
  const input = document.getElementById("chat-input");
  const messages = document.getElementById("chat-messages");

  // Abrir chat al tocar burbuja
  chatBubble.addEventListener("click", () => {
    chatWindow.style.display = "flex";
    chatBubble.style.display = "none";
  });

  // Cerrar chat
  controlBtn.addEventListener("click", () => {
    chatWindow.style.display = "none";
    chatBubble.style.display = "flex";
  });

  // Enviar mensaje (mantiene tu backend intacto)
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const userText = input.value.trim();
    if (!userText) return;

    messages.innerHTML += `<p class="user-message">${escapeHtml(userText)}</p>`;
    messages.scrollTop = messages.scrollHeight;
    input.value = "";

    const typingEl = document.createElement("p");
    typingEl.className = "bot-message";
    typingEl.innerText = "Escribiendo...";
    messages.appendChild(typingEl);
    messages.scrollTop = messages.scrollHeight;

    try {
      const res = await fetch("/api/chatbot/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCSRF()
        },
        body: JSON.stringify({ message: userText })
      });

      const data = await res.json();
      typingEl.remove();

      const botText = (data && (data.reply || data.response || data.message)) || "Lo siento, no entendÃ­.";
      messages.innerHTML += `<p class="bot-message">${escapeHtml(botText)}</p>`;
      messages.scrollTop = messages.scrollHeight;
    } catch (err) {
      typingEl.remove();
      messages.innerHTML += `<p class="bot-message">Error al conectar con el servidor.</p>`;
    }
  });

  function getCSRF() {
    const cookie = document.cookie.split(";").find(c => c.trim().startsWith("csrftoken="));
    return cookie ? cookie.split("=")[1] : "";
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }
});
</script>
