<!-- CHATBOT - WIDGET (con maximizar corregido) -->
<div id="chat-window" aria-live="polite" aria-label="Asistente Instalaciones Universales">
  <div id="chat-header">
    <button id="chat-control-btn" title="Maximizar chat">⛶</button>
    <span>Asistente Instalaciones Universales</span>
    <span style="width: 30px;"></span>
  </div>

  <div id="chat-messages" role="log">
    <p class="bot-message">
      Hola, soy tu asistente de Instalaciones Universales. <br><br>
      ¿En qué puedo ayudarte hoy?
    </p>
  </div>

  <form id="chat-form" autocomplete="off" role="search">
    <input type="text" id="chat-input" placeholder="Escríbeme algo aquí..." autocomplete="off" />
    <button type="submit" id="chat-send-btn">Enviar</button>
  </form>
</div>

<style>
/* ======== CHATBOT ======== */
#chat-window {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 330px;
  height: 430px;
  background: white;
  border-radius: 10px;
  box-shadow: 0px 4px 15px rgba(0,0,0,0.3);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  z-index: 9999;
  transition: width 0.25s ease, height 0.25s ease, right 0.25s ease, bottom 0.25s ease, border-radius 0.25s ease;
  font-family: Arial, sans-serif;
}

/* Clase que indica "un poco más grande" (no full-screen) */
#chat-window.enlarged {
  width: 460px;     /* ancho aumentado */
  height: 620px;    /* alto aumentado */
  bottom: 30px;
  right: 30px;
  border-radius: 12px;
}

/* (opcional) versión más compacta en pantallas pequeñas */
@media (max-width: 600px) {
  #chat-window {
    width: 95%;
    right: 2.5%;
    height: 60vh;
  }
  #chat-window.enlarged {
    width: 98%;
    height: 78vh;
  }
}

#chat-header {
  background: #0a2a43;
  color: white;
  padding: 10px 12px;
  font-size: 15px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}

#chat-header span {
  flex: 1;
  text-align: center;
  padding-left: 8px;
  font-weight: 600;
}

#chat-control-btn {
  background: transparent;
  border: none;
  color: white;
  font-size: 18px;
  cursor: pointer;
  width: 30px;
  height: 30px;
  line-height: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  transition: background 0.15s;
}
#chat-control-btn:hover { background: rgba(255,255,255,0.05); }

#chat-messages {
  flex: 1;
  padding: 14px;
  overflow-y: auto;
  background: #f7f9fb;
  scroll-behavior: smooth;
}

/* Mensajes */
.bot-message {
  background: #dbeaff;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 10px;
  max-width: 85%;
  color: #0b2a43;
}

.user-message {
  background: #d1ffd0;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 10px;
  max-width: 85%;
  margin-left: auto;
  color: #08320f;
}

/* Formulario */
#chat-form {
  display: flex;
  padding: 10px;
  background: #ffffff;
  gap: 8px;
  align-items: center;
  border-top: 1px solid #eee;
}

#chat-input {
  flex: 1;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 6px;
  outline: none;
  font-size: 14px;
}

#chat-input:focus {
  box-shadow: 0 0 0 3px rgba(10,42,67,0.06);
  border-color: #0a2a43;
}

#chat-send-btn {
  background: #0a2a43;
  color: white;
  border: none;
  padding: 9px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
}

#chat-send-btn:hover { opacity: 0.95; }

/* cuando esté minimizado (opcional) */
#chat-window.minimized {
  height: 46px;
  width: 180px;
  border-radius: 10px;
  overflow: visible;
}
#chat-window.minimized #chat-messages,
#chat-window.minimized #chat-form { display: none; }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const chatWindow = document.getElementById("chat-window");
  const controlBtn = document.getElementById("chat-control-btn");
  const form = document.getElementById("chat-form");
  const input = document.getElementById("chat-input");
  const messages = document.getElementById("chat-messages");

  // Alterna entre estado normal y "enlarged" (un poco más grande)
  controlBtn.addEventListener("click", (e) => {
    e.preventDefault();
    // Si está minimizado, restaurar primero
    if (chatWindow.classList.contains("minimized")) {
      chatWindow.classList.remove("minimized");
      controlBtn.innerText = "⛶";
      return;
    }

    // Alterna enlarged
    const isEnlarged = chatWindow.classList.toggle("enlarged");

    // Cambia el icono según estado
    controlBtn.innerText = isEnlarged ? "✖" : "⛶";

    // Asegura que el último mensaje esté visible después de animación
    setTimeout(() => {
      messages.scrollTop = messages.scrollHeight;
    }, 260);
  });

  // Doble click en header para minimizar (opcional)
  document.getElementById("chat-header").addEventListener("dblclick", () => {
    if (!chatWindow.classList.contains("minimized")) {
      chatWindow.classList.add("minimized");
      controlBtn.innerText = "⛶";
    }
  });

  // Enviar mensaje (usa tu fetch existente)
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const userText = input.value.trim();
    if (!userText) return;

    // Mostrar mensaje del usuario
    messages.innerHTML += `<p class="user-message">${escapeHtml(userText)}</p>`;
    messages.scrollTop = messages.scrollHeight;
    input.value = "";

    // Mostrar "escribiendo..."
    const typingEl = document.createElement("p");
    typingEl.className = "bot-message";
    typingEl.innerText = "Escribiendo...";
    messages.appendChild(typingEl);
    messages.scrollTop = messages.scrollHeight;

    try {
      const res = await fetch("/api/chatbot/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCSRF()
        },
        body: JSON.stringify({ message: userText })
      });

      const data = await res.json();
      // eliminar "Escribiendo..."
      typingEl.remove();

      const botText = (data && (data.reply || data.response || data.message)) || "Lo siento, no entendí. ¿Puedes reformular?";
      messages.innerHTML += `<p class="bot-message">${escapeHtml(botText)}</p>`;
      messages.scrollTop = messages.scrollHeight;
    } catch (err) {
      typingEl.remove();
      messages.innerHTML += `<p class="bot-message">Error al contactar con el servidor.</p>`;
      messages.scrollTop = messages.scrollHeight;
      console.error(err);
    }
  });

  // Helper: obtener csrftoken
  function getCSRF() {
    const cookie = document.cookie.split(";").find(c => c.trim().startsWith("csrftoken="));
    return cookie ? cookie.split("=")[1] : "";
  }

  // Helper: escapar html para evitar inyección
  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  // Asegurar scroll inicial al final
  messages.scrollTop = messages.scrollHeight;
});
</script>
